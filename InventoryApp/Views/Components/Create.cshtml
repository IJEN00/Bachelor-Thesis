@model InventoryApp.Models.Component
@{
    ViewData["Title"] = "Nová součástka";
}

<div class="container d-flex justify-content-center align-items-center py-5" style="min-height: 80vh;">
    <div class="card border-0 shadow-sm rounded-4 overflow-hidden" style="max-width: 800px; width: 100%;">

        <div class="card-header bg-primary text-white text-center py-4 border-0">
            <div class="mb-2">
                <i class="bi bi-cpu" style="font-size: 3rem; opacity: 0.9;"></i>
            </div>
            <h4 class="mb-0 fw-bold">Nová součástka</h4>
            <p class="mb-0 opacity-75 small">Zadejte parametry nové položky do skladu.</p>
        </div>

        <div class="card-body p-4 p-md-5">
            <form asp-action="Create" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()

                <h6 class="text-uppercase text-muted fw-bold small mb-3"><i class="bi bi-card-text me-2"></i>Základní údaje</h6>

                <div class="mb-3">
                    <label asp-for="Name" class="form-label fw-bold small text-muted">Název součástky *</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0 text-muted"><i class="bi bi-tag"></i></span>
                        <input asp-for="Name" class="form-control border-start-0 ps-0" placeholder="Např. Rezistor 10k 0805" />
                    </div>
                    <span asp-validation-for="Name" class="text-danger small"></span>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label asp-for="Manufacturer" class="form-label fw-bold small text-muted">Výrobce</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0 text-muted"><i class="bi bi-building"></i></span>
                            <input asp-for="Manufacturer" class="form-control border-start-0 ps-0" placeholder="Např. Vishay" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label asp-for="ManufacturerPartNumber" class="form-label fw-bold small text-muted">MPN (Kód)</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0 text-muted"><i class="bi bi-qr-code"></i></span>
                            <input asp-for="ManufacturerPartNumber" class="form-control border-start-0 ps-0" placeholder="Např. CRCW0805..." />
                        </div>
                    </div>
                </div>

                <h6 class="text-uppercase text-muted fw-bold small mb-3 border-top pt-4"><i class="bi bi-box-seam me-2"></i>Sklad</h6>

                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label asp-for="Quantity" class="form-label fw-bold small text-muted">Počáteční množství</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0 text-muted"><i class="bi bi-layers"></i></span>
                            <input asp-for="Quantity" type="number" class="form-control border-start-0 ps-0" min="0" value="0" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label asp-for="ReorderPoint" class="form-label fw-bold small text-muted">Minimální limit</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0 text-muted"><i class="bi bi-speedometer2"></i></span>
                            <input asp-for="ReorderPoint" class="form-control border-start-0 ps-0" type="number" min="0" value="5" />
                        </div>
                        <div class="form-text small mt-1">Pod tímto limitem se označí "Dochází".</div>
                    </div>
                </div>

                <div class="bg-light rounded-3 p-4 mb-4 border">
                    <h6 class="text-uppercase text-primary fw-bold small mb-3"><i class="bi bi-geo-alt me-2"></i>Umístění (Volitelné)</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-muted">Regál</label>
                            <select id="RackDropdown" class="form-select bg-white border">
                                <option value="">-- Vyber --</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-muted">Šuplík</label>
                            <select id="DrawerDropdown" class="form-select bg-white border" disabled>
                                <option value="">-- Vyber --</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-muted">Krabička</label>
                            <select id="BoxDropdown" name="LocationId" class="form-select bg-white border" disabled>
                                <option value="">-- Vyber --</option>
                            </select>
                        </div>
                    </div>
                </div>

                <h6 class="text-uppercase text-muted fw-bold small mb-3"><i class="bi bi-paperclip me-2"></i>Přílohy</h6>

                <div class="mb-4">
                    <label class="btn btn-outline-secondary w-100 border-dashed py-3" style="border-style: dashed; border-width: 2px;">
                        <div class="d-flex flex-column align-items-center">
                            <i class="bi bi-cloud-arrow-up fs-3 mb-2"></i>
                            <span>Klikni pro výběr souborů (Datasheet, Obrázek...)</span>
                        </div>
                        <input id="filesInput" type="file" name="files" multiple class="d-none" />
                    </label>

                    <div id="filesPreview" class="mt-3 d-none">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted fw-bold text-uppercase">Vybrané soubory</small>
                            <button type="button" id="clearFilesBtn" class="btn btn-sm btn-link text-danger text-decoration-none p-0">Vymazat vše</button>
                        </div>
                        <ul class="list-group list-group-flush border rounded overflow-hidden" id="filesList"></ul>
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a asp-action="Index" class="btn btn-light btn-lg border px-4">Zrušit</a>
                    <button type="submit" class="btn btn-primary btn-lg px-4 shadow-sm">
                        <i class="bi bi-plus-lg me-2"></i> Vytvořit součástku
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        $(document).ready(function () {
            $.getJSON('@Url.Action("GetRacks", "Locations")', function (data) {
                var $rack = $('#RackDropdown');
                $rack.empty().append('<option value="">-- Vyber --</option>');
                $.each(data, function (i, val) {
                    $rack.append('<option value="' + val.rack + '">' + val.rack + '</option>');
                });
            });

            $('#RackDropdown').on('change', function () {
                var rack = $(this).val();
                var $drawer = $('#DrawerDropdown');
                var $box = $('#BoxDropdown');

                $drawer.prop('disabled', true);
                $box.prop('disabled', true).empty().append('<option value="">-- Vyber --</option>');

                if (rack) {
                    $.getJSON('@Url.Action("GetDrawers", "Locations")', { rack: rack }, function (data) {
                        $drawer.empty().append('<option value="">-- Vyber --</option>');
                        $.each(data, function (i, val) {
                            $drawer.append('<option value="' + val.drawer + '">' + val.drawer + '</option>');
                        });
                        $drawer.prop('disabled', false);
                    });
                } else {
                    $drawer.empty().append('<option value="">-- Vyber --</option>');
                }
            });

            $('#DrawerDropdown').on('change', function () {
                var rack = $('#RackDropdown').val();
                var drawer = $(this).val();
                var $box = $('#BoxDropdown');

                $box.prop('disabled', true);

                if (rack && drawer) {
                    $.getJSON('@Url.Action("GetBoxes", "Locations")', { rack: rack, drawer: drawer }, function (data) {
                        $box.empty().append('<option value="">-- Vyber --</option>');
                        $.each(data, function (i, val) {
                            $box.append('<option value="' + val.id + '">' + val.box + '</option>');
                        });
                        $box.prop('disabled', false);
                    });
                } else {
                    $box.empty().append('<option value="">-- Vyber --</option>');
                }
            });
        });

        const filesInput = document.getElementById("filesInput");
        const filesPreview = document.getElementById("filesPreview");
        const filesList = document.getElementById("filesList");
        const clearFilesBtn = document.getElementById("clearFilesBtn");
        let selectedFiles = [];

        function formatBytes(bytes) {
            const units = ["B", "KB", "MB", "GB"];
            let size = bytes; let i = 0;
            while (size >= 1024 && i < units.length - 1) { size /= 1024; i++; }
            return `${size.toFixed(1)} ${units[i]}`;
        }

        function pickIcon(fileName) {
            const ext = (fileName.split('.').pop() || "").toLowerCase();
            if (["pdf"].includes(ext)) return "bi-file-earmark-pdf";
            if (["png", "jpg", "jpeg", "webp", "gif"].includes(ext)) return "bi-file-earmark-image";
            if (["txt", "md"].includes(ext)) return "bi-file-earmark-text";
            if (["zip", "7z", "rar"].includes(ext)) return "bi-file-earmark-zip";
            if (["xls", "xlsx", "csv"].includes(ext)) return "bi-file-earmark-spreadsheet";
            if (["doc", "docx"].includes(ext)) return "bi-file-earmark-word";
            return "bi-file-earmark";
        }

        function syncInputFiles() {
            const dt = new DataTransfer();
            selectedFiles.forEach(f => dt.items.add(f));
            filesInput.files = dt.files;
        }

        function renderPreview() {
            filesList.innerHTML = "";
            if (selectedFiles.length === 0) {
                filesPreview.classList.add("d-none");
                return;
            }
            filesPreview.classList.remove("d-none");

            selectedFiles.forEach((file, index) => {
                const li = document.createElement("li");
                li.className = "list-group-item d-flex justify-content-between align-items-center bg-light";
                li.innerHTML = `
                    <div class="d-flex align-items-center gap-2 overflow-hidden">
                        <i class="bi ${pickIcon(file.name)} text-primary"></i>
                        <div class="text-truncate">
                            <div class="fw-semibold small">${file.name}</div>
                            <div class="text-muted" style="font-size: 0.7em;">${formatBytes(file.size)}</div>
                        </div>
                    </div>
                `;

                const removeBtn = document.createElement("button");
                removeBtn.type = "button";
                removeBtn.className = "btn btn-sm btn-link text-danger p-0 border-0";
                removeBtn.innerHTML = '<i class="bi bi-x-circle-fill"></i>';
                removeBtn.onclick = () => {
                    selectedFiles.splice(index, 1);
                    syncInputFiles();
                    renderPreview();
                };

                li.appendChild(removeBtn);
                filesList.appendChild(li);
            });
        }

        filesInput?.addEventListener("change", (e) => {
            const incoming = Array.from(e.target.files || []);
            incoming.forEach(f => {
                if (!selectedFiles.some(x => x.name === f.name && x.size === f.size)) {
                    selectedFiles.push(f);
                }
            });
            syncInputFiles();
            renderPreview();
        });

        clearFilesBtn?.addEventListener("click", () => {
            selectedFiles = [];
            syncInputFiles();
            renderPreview();
        });
    </script>
}