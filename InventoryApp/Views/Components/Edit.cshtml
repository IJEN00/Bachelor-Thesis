@model InventoryApp.Models.Component
@{
    ViewData["Title"] = "Upravit součástku";
    ViewData["ContentWidth"] = "content-narrow";
}

<div class="d-flex align-items-start justify-content-between gap-3 mb-3 flex-wrap">
    <div>
        <h3 class="mb-1">Upravit součástku</h3>
        <div class="text-muted">Úprava vlastností, úmístění a příloh.</div>
    </div>

    <div class="d-flex gap-2">
        <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-outline-secondary">Náhled</a>
        <a asp-action="Index" class="btn btn-outline-secondary">Zpět</a>
    </div>
</div>

<form asp-action="Edit" method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="Id" />

    <!-- SUMMARY / STOCK INFO -->
    <div class="card shadow-sm mb-3">
        <div class="card-body d-flex justify-content-between align-items-start flex-wrap gap-3">
            <div>
                <div class="text-muted small">Součástka</div>
                <div class="fw-semibold">@Model.Name</div>
            </div>

            <div class="text-end">
                <div class="text-muted small">Aktuální stav skladu</div>
                <span class="badge bg-secondary fs-6 px-3 py-2">@Model.Quantity ks</span>
                <div class="text-muted small mt-1">
                    Pro změnu skladu použij
                    <a asp-action="Details" asp-route-id="@Model.Id" class="text-decoration-none">
                        Add/Use v náhledu
                    </a>.
                </div>

                <input type="hidden" asp-for="Quantity" />
            </div>
        </div>
    </div>

    <!-- BASIC INFO -->
    <div class="card shadow-sm mb-3">
        <div class="card-header bg-light">
            <h5 class="mb-0">Základní údaje</h5>
        </div>

        <div class="card-body">
            <div class="mb-3">
                <label asp-for="Name" class="form-label">Název</label>
                <input asp-for="Name" class="form-control" />
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>

            <div class="row g-3">
                <div class="col-12 col-md-6">
                    <label asp-for="Manufacturer" class="form-label">Výrobce</label>
                    <input asp-for="Manufacturer" class="form-control" />
                </div>

                <div class="col-12 col-md-6">
                    <label asp-for="ManufacturerPartNumber" class="form-label">MPN</label>
                    <input asp-for="ManufacturerPartNumber" class="form-control" />
                </div>
            </div>

            <hr class="my-4" />

            <div class="row g-3">
                <div class="col-12 col-md-6">
                    <label asp-for="ReorderPoint" class="form-label">Minimální množství</label>
                    <input asp-for="ReorderPoint" class="form-control" type="number" min="0" />
                    <div class="form-text">Docházející se označí, když bude <strong>sklad &lt; minimum</strong>.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- LOCATION -->
    <div class="card shadow-sm mb-3">
        <div class="card-header bg-light">
            <h5 class="mb-0">Umístění ve skladu</h5>
        </div>

        <div class="card-body">
            <div class="row g-3">
                <div class="col-12 col-md-4">
                    <label class="form-label">Regál</label>
                    <select id="RackDropdown" class="form-select">
                        <option value="">-- Vyber regál --</option>
                    </select>
                </div>

                <div class="col-12 col-md-4">
                    <label class="form-label">Šuplík</label>
                    <select id="DrawerDropdown" class="form-select" disabled>
                        <option value="">-- Vyber šuplík --</option>
                    </select>
                </div>

                <div class="col-12 col-md-4">
                    <label class="form-label">Krabička</label>
                    <select id="BoxDropdown" name="LocationId" class="form-select" disabled>
                        <option value="">-- Vyber krabičku --</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW FILES + PREVIEW -->
    <div class="card shadow-sm mb-3">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="bi bi-paperclip me-1"></i> Nové přílohy</h5>
        </div>
        <div class="card-body">
            <label class="form-label">Vyber soubory</label>
            <input id="filesInput" type="file" name="files" multiple class="form-control" />
            <div class="form-text mb-2">Přidané soubory se uloží po kliknutí na “Uložit změny”.</div>

            <div id="filesPreview" class="mt-2 d-none">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="text-muted small">Vybrané soubory</div>
                    <button type="button" id="clearFilesBtn" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-x-lg me-1"></i> Vymazat vše
                    </button>
                </div>

                <ul class="list-group" id="filesList"></ul>
            </div>
        </div>
    </div>

    <!-- EXISTING DOCUMENTS -->
    <div class="card shadow-sm mb-3">
        <div class="card-header bg-light d-flex align-items-center justify-content-between">
            <h5 class="mb-0"><i class="bi bi-folder2-open me-1"></i> Existující přílohy</h5>
            <span class="badge bg-secondary-subtle text-secondary border">@(Model.Documents?.Count ?? 0)</span>
        </div>

        <div class="card-body">
            @if (Model.Documents != null && Model.Documents.Any())
            {
                <ul class="list-group" id="documentsList">
                    @foreach (var doc in Model.Documents.OrderByDescending(d => d.UploadedAt))
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-start gap-2" id="doc-@doc.Id">
                            <div>
                                <a href="~/@doc.FilePath" target="_blank" class="text-decoration-none">
                                    <i class="bi bi-file-earmark-text me-1"></i> @doc.FileName
                                </a>
                                <div class="text-muted small">@doc.UploadedAt.ToLocalTime().ToString("g")</div>
                            </div>

                            <button type="button"
                                    class="btn btn-sm btn-outline-danger delete-doc"
                                    data-id="@doc.Id"
                                    title="Smazat přílohu">
                                <i class="bi bi-trash"></i>
                            </button>
                        </li>
                    }
                </ul>
            }
            else
            {
                <div class="text-muted">Žádné přílohy nejsou k dispozici.</div>
            }
        </div>
    </div>

    <!-- ACTIONS -->
    <div class="d-flex justify-content-end gap-2">
        <a asp-action="Index" class="btn btn-outline-secondary">Zrušit</a>
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-lg me-1"></i> Uložit změny
        </button>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        // --- Location dropdown preselect logic (tvoje) ---
        $(document).ready(function () {
            const selectedLocationId = '@Model.LocationId';
            let selectedRack = '';
            let selectedDrawer = '';
            let selectedBoxId = selectedLocationId;

            $.getJSON('@Url.Action("GetRacks", "Locations")', function (racks) {
                const $rack = $('#RackDropdown');
                $rack.empty().append('<option value="">-- Vyber regál --</option>');
                $.each(racks, function (i, val) {
                    $rack.append('<option value="' + val.rack + '">' + val.rack + '</option>');
                });

                if (selectedLocationId && selectedLocationId !== '0') {
                    $.getJSON('@Url.Action("GetLocationById", "Locations")', { id: selectedLocationId }, function (loc) {
                        selectedRack = loc.rack;
                        selectedDrawer = loc.drawer;
                        $rack.val(selectedRack).trigger('change');
                    });
                }
            });

            $('#RackDropdown').on('change', function () {
                const rack = $(this).val();
                const $drawer = $('#DrawerDropdown');
                const $box = $('#BoxDropdown');

                $drawer.prop('disabled', true);
                $box.prop('disabled', true).empty().append('<option value="">-- Vyber krabičku --</option>');

                if (rack) {
                    $.getJSON('@Url.Action("GetDrawers", "Locations")', { rack: rack }, function (drawers) {
                        $drawer.empty().append('<option value="">-- Vyber šuplík --</option>');
                        $.each(drawers, function (i, val) {
                            $drawer.append('<option value="' + val.drawer + '">' + val.drawer + '</option>');
                        });
                        $drawer.prop('disabled', false);

                        if (selectedDrawer && selectedRack === rack) {
                            $drawer.val(selectedDrawer).trigger('change');
                        }
                    });
                }
            });

            $('#DrawerDropdown').on('change', function () {
                const rack = $('#RackDropdown').val();
                const drawer = $(this).val();
                const $box = $('#BoxDropdown');

                $box.prop('disabled', true);

                if (rack && drawer) {
                    $.getJSON('@Url.Action("GetBoxes", "Locations")', { rack: rack, drawer: drawer }, function (boxes) {
                        $box.empty().append('<option value="">-- Vyber krabičku --</option>');
                        $.each(boxes, function (i, val) {
                            $box.append('<option value="' + val.id + '">' + val.box + '</option>');
                        });
                        $box.prop('disabled', false);

                        if (selectedBoxId && selectedRack === rack && selectedDrawer === drawer) {
                            $box.val(selectedBoxId);
                        }
                    });
                }
            });
        });

        // --- Delete existing document (tvoje) ---
        $(document).on('click', '.delete-doc', function () {
            const id = $(this).data('id');
            if (confirm('Opravdu chceš smazat tento soubor?')) {
                $.ajax({
                    url: '@Url.Action("DeleteDocument", "Components")',
                    type: 'POST',
                    data: { id: id },
                    success: function () {
                        $('#doc-' + id).fadeOut(200, function () { $(this).remove(); });
                    },
                    error: function () {
                        alert('Nepodařilo se smazat soubor.');
                    }
                });
            }
        });

        // --- New files preview (same as Create) ---
        const filesInput = document.getElementById("filesInput");
        const filesPreview = document.getElementById("filesPreview");
        const filesList = document.getElementById("filesList");
        const clearFilesBtn = document.getElementById("clearFilesBtn");
        let selectedFiles = [];

        function formatBytes(bytes) {
            const units = ["B", "KB", "MB", "GB"];
            let size = bytes;
            let i = 0;
            while (size >= 1024 && i < units.length - 1) {
                size /= 1024;
                i++;
            }
            return `${size.toFixed(i === 0 ? 0 : 1)} ${units[i]}`;
        }

        function pickIcon(fileName) {
            const ext = (fileName.split('.').pop() || "").toLowerCase();
            if (["pdf"].includes(ext)) return "bi-file-earmark-pdf";
            if (["png", "jpg", "jpeg", "webp", "gif"].includes(ext)) return "bi-file-earmark-image";
            if (["txt", "md"].includes(ext)) return "bi-file-earmark-text";
            if (["zip", "7z", "rar"].includes(ext)) return "bi-file-earmark-zip";
            if (["xls", "xlsx", "csv"].includes(ext)) return "bi-file-earmark-spreadsheet";
            if (["doc", "docx"].includes(ext)) return "bi-file-earmark-word";
            return "bi-file-earmark";
        }

        function syncInputFiles() {
            const dt = new DataTransfer();
            for (const f of selectedFiles) dt.items.add(f);
            filesInput.files = dt.files;
        }

        function renderPreview() {
            filesList.innerHTML = "";

            if (selectedFiles.length === 0) {
                filesPreview.classList.add("d-none");
                return;
            }

            filesPreview.classList.remove("d-none");

            selectedFiles.forEach((file, index) => {
                const li = document.createElement("li");
                li.className = "list-group-item d-flex justify-content-between align-items-center gap-2";

                const left = document.createElement("div");
                left.className = "d-flex align-items-center gap-2";

                const icon = document.createElement("i");
                icon.className = `bi ${pickIcon(file.name)} text-muted`;

                const meta = document.createElement("div");
                meta.innerHTML = `
                    <div class="fw-semibold">${file.name}</div>
                    <div class="text-muted small">${formatBytes(file.size)}</div>
                `;

                left.appendChild(icon);
                left.appendChild(meta);

                const removeBtn = document.createElement("button");
                removeBtn.type = "button";
                removeBtn.className = "btn btn-sm btn-outline-danger";
                removeBtn.innerHTML = `<i class="bi bi-trash"></i>`;
                removeBtn.title = "Odebrat soubor";
                removeBtn.addEventListener("click", () => {
                    selectedFiles.splice(index, 1);
                    syncInputFiles();
                    renderPreview();
                });

                li.appendChild(left);
                li.appendChild(removeBtn);
                filesList.appendChild(li);
            });
        }

        filesInput?.addEventListener("change", (e) => {
            const incoming = Array.from(e.target.files || []);
            if (incoming.length === 0) return;

            for (const f of incoming) {
                const exists = selectedFiles.some(x =>
                    x.name === f.name && x.size === f.size && x.lastModified === f.lastModified
                );
                if (!exists) selectedFiles.push(f);
            }

            syncInputFiles();
            renderPreview();
        });

        clearFilesBtn?.addEventListener("click", () => {
            selectedFiles = [];
            syncInputFiles();
            renderPreview();
        });
    </script>
}